LIBRARY({name:"StorageInterface",version:12,shared:!0,api:"CoreEngine"});var StorageInterface,LIQUID_STORAGE_MAX_LIMIT=99999999,NativeContainerInterface=function(){function t(t){this.isNativeContainer=!0,this.container=t}return t.prototype.getSlot=function(t){return this.container.getSlot(t)},t.prototype.setSlot=function(t,e,i,n,r){void 0===r&&(r=null),this.container.setSlot(t,e,i,n,r)},t.prototype.getContainerSlots=function(){for(var t=[],e=this.container.getSize(),i=0;i<e;i++)t.push(i);return t},t.prototype.getInputSlots=function(t){var e=this.container.getType();switch(e){case 1:case 38:case 39:return[1==t?0:1];case 8:return[1==t?0:4];default:return this.getContainerSlots()}},t.prototype.getReceivingItemCount=function(t,e){for(var i=this.getInputSlots(e),n=0,r=0,o=i;r<o.length;r++){var a=o[r],u=this.getSlot(a);if((0==u.id||u.id==t.id&&u.data==t.data)&&(n+=Item.getMaxStack(t.id)-u.count,n>=t.count))break}return Math.min(t.count,n)},t.prototype.addItemToSlot=function(t,e,i){var n=this.getSlot(t),r=StorageInterface.addItemToSlot(e,n,i);return r>0&&this.setSlot(t,n.id,n.count,n.data,n.extra),r},t.prototype.addItem=function(t,e,i){void 0===i&&(i=64);for(var n=0,r=this.getInputSlots(e),o=0;o<r.length&&(n+=this.addItemToSlot(o,t,i),!(0==t.count||n>=i));o++);return n},t.prototype.getOutputSlots=function(){var t=this.container.getType();switch(t){case 1:case 38:case 39:return[2];case 8:return[1,2,3];default:return this.getContainerSlots()}},t.prototype.clearContainer=function(){for(var t=this.container.getSize(),e=0;e<t;e++)this.container.setSlot(e,0,0,0)},t}(),TileEntityInterface=function(){function t(t){this.liquidUnitRatio=1,this.isNativeContainer=!1,this.tileEntity=t,this.container=t.container;var e=StorageInterface.getData(t.blockID);if(e)for(var i in e)this[i]=e[i]}return t.prototype.getSlot=function(t){return this.container.getSlot(t)},t.prototype.setSlot=function(t,e,i,n,r){void 0===r&&(r=null),this.container.setSlot(t,e,i,n,r)},t.prototype.getSlotData=function(t){return this.slots?this.slots[t]:null},t.prototype.getSlotMaxStack=function(t){var e=this.getSlotData(t);return e&&e.maxStack||64},t.prototype.isValidSlotSide=function(t,e){if(null==t||-1==e)return!0;if("number"==typeof t)return t==e;switch(t){case"horizontal":return e>1;case"verctical":return e<=1;case"down":return 0==e;case"up":return 1==e}return!1},t.prototype.isValidSlotInput=function(t,e,i){var n=this.getSlotData(t);return!n||!n.isValid||n.isValid(e,i,this.tileEntity)},t.prototype.getContainerSlots=function(){return Object.keys(this.slots||this.container.slots)},t.prototype.getDefaultSlots=function(t){return this.tileEntity.getTransportSlots?this.tileEntity.getTransportSlots()[t]:this.getContainerSlots()},t.prototype.getInputSlots=function(t){if(void 0===t&&(t=-1),!this.slots)return this.getDefaultSlots("input");var e=[];for(var i in this.slots){var n=this.getSlotData(i);n.input&&this.isValidSlotSide(n.side,t)&&e.push(i)}return e},t.prototype.getReceivingItemCount=function(t,e){if(void 0===e&&(e=-1),!this.isValidInput(t,e,this.tileEntity))return 0;for(var i=this.getInputSlots(e),n=0,r=0,o=i;r<o.length;r++){var a=o[r];if(this.isValidSlotInput(a,t,e)){var u=this.getSlot(a);if(0==u.id||u.id==t.id&&u.data==t.data){var s=Math.min(Item.getMaxStack(t.id),this.getSlotMaxStack(a));if(n+=s-u.count,n>=t.count)break}}}return Math.min(t.count,n)},t.prototype.isValidInput=function(t,e,i){return!0},t.prototype.addItemToSlot=function(t,e,i){void 0===i&&(i=64);var n=this.getSlot(t),r=this.getSlotMaxStack(t),o=StorageInterface.addItemToSlot(e,n,Math.min(i,r));return o>0&&this.setSlot(t,n.id,n.count,n.data,n.extra),o},t.prototype.addItem=function(t,e,i){if(void 0===e&&(e=-1),void 0===i&&(i=64),!this.isValidInput(t,e,this.tileEntity))return 0;for(var n=0,r=this.getInputSlots(e),o=0,a=r;o<a.length;o++){var u=a[o];if(this.isValidSlotInput(u,t,e)&&(n+=this.addItemToSlot(u,t,i-n),0==t.count||n>=i))break}return n},t.prototype.getOutputSlots=function(t){if(void 0===t&&(t=-1),!this.slots)return this.getDefaultSlots("output");var e=[];for(var i in this.slots){var n=this.slots[i];if(n.output){var r=this.container.getSlot(i);!this.isValidSlotSide(n.side,t)||n.canOutput&&!n.canOutput(r,t,this.tileEntity)||e.push(i)}}return e},t.prototype.clearContainer=function(){for(var t in this.container.slots)this.container.clearSlot(t)},t.prototype.canReceiveLiquid=function(t,e){return this.getInputTank(e).getLimit(t)<LIQUID_STORAGE_MAX_LIMIT},t.prototype.canTransportLiquid=function(t,e){return!0},t.prototype.receiveLiquid=function(t,e,i){var n=t.getLiquidStored();return n&&n!=e?0:i-t.addLiquid(e,i/this.liquidUnitRatio)*this.liquidUnitRatio},t.prototype.extractLiquid=function(t,e,i){return t.getLiquid(e,i/this.liquidUnitRatio)*this.liquidUnitRatio},t.prototype.getInputTank=function(t){return this.tileEntity.liquidStorage},t.prototype.getOutputTank=function(t){return this.tileEntity.liquidStorage},t}();(function(t){function e(e){return t.data[e]}function i(e,i){var n=t.directionsBySide[i];return{x:e.x+n.x,y:e.y+n.y,z:e.z+n.z}}function n(t,e,i){t.setSlotAddTransferPolicy(e,function(t,e,n,r,o){var a=Math.min(i,Item.getMaxStack(n));return Math.max(0,Math.min(r,a-t.getSlot(e).count))})}function r(t,e,i){t.setSlotAddTransferPolicy(e,function(t,e,n,r,o,a,u){return r=Math.min(r,Item.getMaxStack(n)-t.getSlot(e).count),i(e,n,r,o,a,t,u)?r:0})}function o(t,e){t.setGlobalAddTransferPolicy(function(t,i,n,r,o,a,u){return r=Math.min(r,Item.getMaxStack(n)-t.getSlot(i).count),e(i,n,r,o,a,t,u)?r:0})}function a(t){return"container"in t?new TileEntityInterface(t):"getParent"in t?new TileEntityInterface(t.getParent()):new NativeContainerInterface(t)}function u(e,i){if(i.slots){for(var n in i.slots)if(n.includes("^")){for(var r=i.slots[n],o=n.split("^"),a=o[1].split("-"),u=parseInt(a[0]);u<=parseInt(a[1]);u++)i.slots[o[0]+u]=r;delete i.slots[n]}}else i.slots={};t.data[e]=i}function s(t,e,i){if(void 0===i&&(i=64),0==e.id||e.id==t.id&&e.data==t.data){var n=Item.getMaxStack(t.id),r=Math.min(t.count,n-e.count);if(i<r&&(r=i),r>0)return e.id=t.id,e.data=t.data,t.extra&&(e.extra=t.extra),e.count+=r,t.count-=r,0==t.count&&(t.id=t.data=0,t.extra=null),r}return 0}function c(t,e,i,n){var r=t.getBlockEntity(e,i,n);if(r&&r.getSize()>0)return new NativeContainerInterface(r);var o=World.getTileEntity(e,i,n,t);return o&&o.container&&o.__initialized?new TileEntityInterface(o):null}function l(t,e,i,n){var r=World.getTileEntity(e,i,n,t);return r&&r.__initialized?new TileEntityInterface(r):null}function f(t,e,n){var r=i(e,n);return c(t,r.x,r.y,r.z)}function d(t,e,n){var r=i(e,n);return l(t,r.x,r.y,r.z)}function g(t,e){var n=-1;"number"==typeof e&&(e=null,n=e);for(var r={},o=0;o<6;o++)if(!(n>=0&&o!=n)){var a=i(t,o),u=World.getContainer(a.x,a.y,a.z,e);u&&(r[o]=u)}return r}function p(t,e){var i=-1;"number"==typeof e&&(e=null,i=e);for(var n={},r=0;r<6;r++)if(!(i>=0&&i!=r)){var o=d(e,t,r);o&&(n[r]=o)}return n}function S(t){if("slots"in t)return Object.keys(t.slots);for(var e=[],i=t.getSize(),n=0;n<i;n++)e.push(n);return e}function h(t,e){for(var i in t){var n=t[i];for(var r in e){if(0==n.count)break;var o=e[r];v(n,o,1^parseInt(r))}}}function v(t,e,i,n){var r=a(e);return r.addItem(t,i,n)}function y(t,e,i,n,r){var o=a(t),u=a(e);return I(o,u,i,n,r)}function I(t,e,i,n,r){for(var o=0,a=e.getOutputSlots(1^i),u=0,s=a;u<s.length;u++){var c=s[u],l=e.getSlot(c);if(0!==l.id){var f=t.addItem(l,i,n-o);if(f>0&&(o+=f,e.setSlot(c,l.id,l.count,l.data,l.extra),r||o>=n))break}}return o}function m(t,e,i,n,r){i instanceof TileEntityInterface||(i=new TileEntityInterface(i));var o=1^r,a=i.getInputTank(r),u=n.getOutputTank(o);if(!a||!u)return 0;if(t||(t=u.getLiquidStored()),t&&n.canTransportLiquid(t,o)&&i.canReceiveLiquid(t,r)&&!a.isFull(t)){var s=Math.min(u.getAmount(t)*n.liquidUnitRatio,e);return s=i.receiveLiquid(a,t,s),n.extractLiquid(u,t,s),s}return 0}function T(t,e,i,n,r){i instanceof TileEntityInterface||(i=new TileEntityInterface(i));var o=1^r,a=n.getInputTank(o),u=i.getOutputTank(r);if(!a||!u)return 0;if(n.canReceiveLiquid(t,o)&&!a.isFull(t)){var s=Math.min(u.getAmount(t)*i.liquidUnitRatio,e);return s=n.receiveLiquid(a,t,s),i.extractLiquid(u,t,s),s}return 0}function x(e){if(!(World.getThreadTime()%8>0)){for(var n=e.blockSource,r=t.getInterface(e),o=1;o<6;o++){var a=i(e,o),u=n.getBlock(a.x,a.y,a.z);if(154==u.id&&u.data==o+Math.pow(-1,o)){var s=t.getStorage(n,a.x,a.y,a.z);I(r,s,o,1)}}if(154==n.getBlockId(e.x,e.y-1,e.z)){s=t.getStorage(n,e.x,e.y-1,e.z);I(s,r,0,1)}}}t.data={},t.getData=e,t.directionsBySide=[{x:0,y:-1,z:0},{x:0,y:1,z:0},{x:0,y:0,z:-1},{x:0,y:0,z:1},{x:-1,y:0,z:0},{x:1,y:0,z:0}],t.getRelativeCoords=i,t.setSlotMaxStackPolicy=n,t.setSlotValidatePolicy=r,t.setGlobalValidatePolicy=o,t.getInterface=a,t.createInterface=u,t.addItemToSlot=s,t.getStorage=c,t.getLiquidStorage=l,t.getNeighbourStorage=f,t.getNeighbourLiquidStorage=d,t.getNearestContainers=g,t.getNearestLiquidStorages=p,t.getContainerSlots=S,t.putItems=h,t.putItemToContainer=v,t.extractItemsFromContainer=y,t.extractItemsFromStorage=I,t.extractLiquid=m,t.transportLiquid=T,t.checkHoppers=x})(StorageInterface||(StorageInterface={})),Callback.addCallback("TileEntityAdded",function(t,e){e&&t.container.setParent(t),StorageInterface.data[t.blockID]&&(t.interface=new TileEntityInterface(t))}),EXPORT("StorageInterface",StorageInterface);